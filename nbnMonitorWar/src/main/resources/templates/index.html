<!DOCTYPE HTML>
<html>
<head>
    <title>NBN Outages</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <!--  Polyfills required for tabulator to run under IE11 -->
    <script src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@3.3.1/dist/fetch.umd.min.js"></script>

    <link href="css/nbnMonitor.css" rel="stylesheet">
    <link href="https://unpkg.com/tabulator-tables@4.7.1/dist/css/tabulator.min.css" rel="stylesheet">
    <link href="https://unpkg.com/tabulator-tables@4.7.1/dist/css/bulma/tabulator_bulma.min.css" rel="stylesheet">

    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.7.1/dist/js/tabulator.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/moment@2.27.0/min/moment.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>

    <!--
     then include the Litepicker library -->
    <script>window.MSInputMethodContext && document.documentMode && document.write('<script src="https://cdn.jsdelivr.net/npm/ie11-custom-properties@latest/ie11CustomProperties.js"><\x2fscript>');</script>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/js/main.js"></script>    

</head>
<body>
  <p>Outages from <input id="outageDateFrom" /> to <input id="outageDateTo" /></p>

  <div class="chart-container" style="position: relative; height:80vh; width:90vw">
    <canvas id="myChart"></canvas>
  </div>
  <div id="example-table"></div>

  <script type="text/javascript">

    const API_DATE_FORMAT = "YYYY-MM-DD";
    const API_URL = "api/dailySummary";

    window.onload = function() {

	  var fromDate = moment().subtract(1, 'months');
	  var toDate = moment(); 

	
	  var picker = new Litepicker({
		element: document.getElementById('outageDateFrom'),
		elementEnd: document.getElementById('outageDateTo'),
		startDate: fromDate,
        endDate: toDate,
		format: API_DATE_FORMAT,
		numberOfMonths: 2,
		numberOfColumns: 2,
		singleMode: false,
		splitView: true,
		onSelect: function(fromDate, toDate) {
          table.setData(API_URL, {startDate: moment(fromDate).format(API_DATE_FORMAT), endDate: moment(toDate).format(API_DATE_FORMAT)});
		}
      });

      //create Tabulator on DOM element with id "example-table"
      var table = new Tabulator("#example-table", {
    	ajaxURL: API_URL,
    	ajaxParams:{startDate: fromDate.format(API_DATE_FORMAT), endDate: toDate.format(API_DATE_FORMAT)},
        ajaxResponse:function(url, params, response){
            //url - the URL of the request
            //params - the parameters passed with the request
            //response - the JSON object returned in the body of the response.
            var dates = [];
            var outages = [];
            var testCounts = [];

            // console.log("response: ", response;
            response.forEach(function (item, index) {
            	  //console.log(item, index);
            	  dates.unshift(item.date);
                  outages.unshift(item.outageCount);
            	  testCounts.unshift(item.testCount);
            	});
            createGraph( dates, outages, testCounts);
            
            
            return response; //return the tableData property of a response json object
        },
        height:400, // set height of table (in CSS or here), this enables the Virtual DOM and improves render speed dramatically (can be any valid css height value)
        layout:"fitColumns", //fit columns to width of table (optional)
        columns:[ //Define Table Columns
            {title:"Date", field:"date", width:"25%", align:"left",
            	formatter:"datetime", formatterParams:{
            	    inputFormat:"YYYY-MM-DD",
            	    outputFormat:"ddd, D MMM YYYY",
            	    invalidPlaceholder:"(invalid date)"}
              },
            {title:"Outage Count", field:"outageCount", width:"24%", align:"right"},
            {title:"Number of failed tests", field:"failedTestCount", width:"24%", align:"right" },
            {title:"Total test count", field:"testCount", width:"24%", align:"right" },
        ],
        rowClick:function(e, row){ //trigger an alert message when the row is clicked
          openOutageDetailPage(row.getData().date);
        },
      });    

      var ctx = document.getElementById('myChart').getContext('2d');
      var myChart;
      

  function openOutageDetailPage( date) {
      window.location.href = "outage?date=" + date;
  }
      
  function createGraph( dates, outages, testCounts) {

    var barColors = [];
	outages.forEach(function (outageCount, index) {
      var barColour = 'rgba(246, 39, 39, 0.71)';
      if (outageCount < 2) {
        barColour = 'rgba(18, 211, 18, 0.71)';
      } else if (outageCount < 6) {
        barColour = 'rgba(237, 240, 34, 0.84)';
      } 
      barColors.push(barColour);
    });

	if (myChart == null) {
      myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: dates,
            datasets: [{
                    label: 'Outages',
                    data: outages,
                    backgroundColor: barColors,
                    yAxisID: 'y-axis-outages'
                },{
                    label: 'Tests Performed',
                    type: 'line',
                    borderColor: 'rgb(153, 102, 255)',
                    fill: false,
//                    backgroundColor: 'rgb(153, 102, 255)',                    
                    data: testCounts,
                    yAxisID: 'y-axis-testCount'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            title: {
                display: true,
                text: 'NBN Monitoring for Outages'
            },
            scales: {
                yAxes: [{
                    type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
                    display: true,
                    position: 'left',
                    id: 'y-axis-outages',
                    ticks: {
                        beginAtZero: true
                    }
                }, {
                    type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
                    display: true,
                    position: 'right',
                    id: 'y-axis-testCount',
                    // grid line settings
                    gridLines: {
                        drawOnChartArea: false, // only want the grid lines for one axis to show up
                    },
                    includeZero: true,
                    ticks: {
                        beginAtZero: true
                    },
                }],
            }
        }
      })
      
      document.getElementById("myChart").onclick = function(evt) {   
          var activePoints = myChart.getElementsAtEvent(evt);

          if(activePoints.length > 0)
          {
            //get the internal index of slice in pie chart
            var clickedElementindex = activePoints[0]["_index"];

            //get specific label by index 
            var label = myChart.data.labels[clickedElementindex];

            //get value by index      
            var value = myChart.data.datasets[0].data[clickedElementindex];

            /* other stuff that requires slice's label and value */
            openOutageDetailPage(label);
         }
      }    

	} else {
		myChart.data = {
	       labels: dates,
	       datasets: [{
	                    label: 'Outages',
	                    data: outages,
	                    backgroundColor: barColors,
	                    yAxisID: 'y-axis-outages'
	       },{
	                    label: 'Tests Performed',
	                    type: 'line',
	                    borderColor: 'rgb(153, 102, 255)',
	                    fill: false,
//	                    backgroundColor: 'rgb(153, 102, 255)',                    
	                    data: testCounts,
	                    yAxisID: 'y-axis-testCount'
	       }]
		};
		myChart.update();
	}
  }
}
    
</script>
</body>
</html>