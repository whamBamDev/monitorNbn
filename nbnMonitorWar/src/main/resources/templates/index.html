<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <title>NBN Outages</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <script th:src="@{external/jquery/1.12.4/jquery-1.12.4.min.js}"></script>

    <!--  Polyfills required for tabulator to run under IE11 -->
    <script th:src="@{external/promise-polyfill/8.1.3/polyfill.min.js}"></script>
    <script th:src="@{external/whatwg-fetch/3.4.0/fetch.umd.min.js}"></script>
    
    <link th:href="@{external/tabulator-tables/4.7.1/css/tabulator.min.css}" rel="stylesheet" />
    <link th:href="@{external/tabulator-tables/4.7.1/css/tabulator_bulma.min.css}" rel="stylesheet" />

    <script th:src="@{external/tabulator-tables/4.7.1/js/tabulator.min.js}"></script>
    <script th:src="@{external/moment/2.27.0/js/moment.min.js}"></script>

    <script th:src="@{external/chart.js/2.9.3/Chart.min.js}"></script>

    <!--
     then include the Litepicker library -->
    <script>window.MSInputMethodContext && document.documentMode && document.write('<script src="external/ie11-custom-properties/4.1.0/ie11CustomProperties.min.js"><\x2fscript>');</script>
    <script th:src="@{external/litepicker/1.5.7/main.min.js}"></script>

    <link th:href="@{css/nbnMonitor.css}" rel="stylesheet" />

  </head>
  <body>
    <p>Outages from <input id="outageDateFrom" /> to <input id="outageDateTo" /></p>

    <div class="chart-container" style="position: relative; height:80vh; width:90vw">
      <canvas id="outageChart"></canvas>
    </div>
    <div id="outageTable"></div>

    <script type="text/javascript">

    const API_DATE_FORMAT = "YYYY-MM-DD";
    const UI_DATE_FORMAT = "DD-MM-YYYY";
    const API_URL = "api/dailySummary";

    var picker;
    var chartContext = document.getElementById("outageChart").getContext('2d');
    var outageChart;
    var outageTable;
    
    var outageDateFrom = moment().subtract(1, 'months');
    var outageDateTo = moment(); 

    function initialisePage() {
      var outageDateFromStr = $("#outageDateFrom").val();
      var outageDateToStr = $("#outageDateTo").val();
      console.log("initpage",outageDateFromStr,outageDateToStr)
      $("#outageDateFrom").val("");
      $("#outageDateTo").val("");
      if(outageDateFromStr && outageDateFromStr != "") {
        var date = moment(outageDateFromStr,UI_DATE_FORMAT);
        if( date.isValid()) {
          outageDateFrom = date;
        }
      }
      if(outageDateToStr && outageDateToStr != "") {
        var date = moment(outageDateToStr,UI_DATE_FORMAT);
        if( date.isValid()) {
          outageDateTo = date;
        }
      }
        
      picker = new Litepicker({
        element: document.getElementById('outageDateFrom'),
        elementEnd: document.getElementById('outageDateTo'),
        startDate: outageDateFrom,
        endDate: outageDateTo,
        format: UI_DATE_FORMAT,
        numberOfMonths: 2,
        numberOfColumns: 2,
        singleMode: false,
        splitView: true,
        onSelect: function(selectedFromDate, selectedToDate) {
          console.log("onSelect", selectedFromDate, selectedToDate);
          outageTable.setData(API_URL, {startDate: moment(selectedFromDate).format(API_DATE_FORMAT), endDate: moment(selectedToDate).format(API_DATE_FORMAT)});
        }
      });

      console.log("table", outageDateFrom, outageDateTo);
      //create Tabulator on DOM element with id "outageTable"
      outageTable = new Tabulator("#outageTable", {
        ajaxURL: API_URL,
        ajaxParams:{startDate: outageDateFrom.format(API_DATE_FORMAT), endDate: outageDateTo.format(API_DATE_FORMAT)},
        ajaxResponse:function(url, params, response){
            //url - the URL of the request
            //params - the parameters passed with the request
            //response - the JSON object returned in the body of the response.
            var dates = [];
            var outages = [];
            var testCounts = [];

            // console.log("response: ", response;
            response.forEach(function (item, index) {
                  //console.log(item, index);
                  dates.unshift(item.date);
                  outages.unshift(item.outageCount);
                  testCounts.unshift(item.testCount);
                });
            createGraph( dates, outages, testCounts);
            
            
            return response; //return the tableData property of a response json object
        },
        height:400, // set height of table (in CSS or here), this enables the Virtual DOM and improves render speed dramatically (can be any valid css height value)
        layout:"fitColumns", //fit columns to width of table (optional)
        columns:[ //Define Table Columns
            {title:"Date", field:"date", width:"25%", hozAlign:"left",
                formatter:"datetime", formatterParams:{
                    inputFormat:"YYYY-MM-DD",
                    outputFormat:"ddd, D MMM YYYY",
                    invalidPlaceholder:"(invalid date)"}
              },
            {title:"Outage Count", field:"outageCount", width:"24%", hozAlign:"right"},
            {title:"Number of failed tests", field:"failedTestCount", width:"24%", hozAlign:"right" },
            {title:"Total test count", field:"testCount", width:"24%", hozAlign:"right" },
        ],
        rowClick:function(e, row){ //trigger an alert message when the row is clicked
          openOutageDetailPage(row.getData().date);
        },
      });    
    }

    $(document).ready(function(){
      var outageDateFromStr = $("#outageDateFrom").val();
      var outageDateToStr = $("#outageDateTo").val();
      console.log("document ready",outageDateFromStr,outageDateToStr);
        
      if (window.navigator.userAgent.indexOf("Edg") > -1) {
        // For microsoft Edge add a short delay. When going to previous page then it seems that Edge requires a little bit more 
        // time to populate the date fields.
        setTimeout(initialisePage, 10);
      } else {
        initialisePage();
      }
    });
    

    function openOutageDetailPage( date) {
      window.location.href = "outage?date=" + date;
    }

    function createGraph( dates, outages, testCounts) {
      var barColors = [];
	  outages.forEach(function (outageCount, index) {
        var barColour = 'rgba(246, 39, 39, 0.71)';
        if (outageCount < 2) {
          barColour = 'rgba(18, 211, 18, 0.71)';
        } else if (outageCount < 6) {
          barColour = 'rgba(237, 240, 34, 0.84)';
        } 
        barColors.push(barColour);
      });

      if (outageChart == null) {
        outageChart = new Chart(chartContext, {
          type: 'bar',
          data: {
            labels: dates,
            datasets: [{
                    label: 'Outages',
                    data: outages,
                    backgroundColor: barColors,
                    yAxisID: 'y-axis-outages'
                },{
                    label: 'Tests Performed',
                    type: 'line',
                    borderColor: 'rgb(153, 102, 255)',
                    fill: false,
//                    backgroundColor: 'rgb(153, 102, 255)',                    
                    data: testCounts,
                    yAxisID: 'y-axis-testCount'
                }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            title: {
                display: true,
                text: 'NBN Monitoring for Outages'
            },
            scales: {
                yAxes: [{
                    type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
                    display: true,
                    position: 'left',
                    id: 'y-axis-outages',
                    ticks: {
                        beginAtZero: true
                    }
                }, {
                    type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
                    display: true,
                    position: 'right',
                    id: 'y-axis-testCount',
                    // grid line settings
                    gridLines: {
                        drawOnChartArea: false, // only want the grid lines for one axis to show up
                    },
                    includeZero: true,
                    ticks: {
                        beginAtZero: true
                    },
                }],
            }
          }
        })
      
        document.getElementById("outageChart").onclick = function(evt) {   
          var activePoints = outageChart.getElementsAtEvent(evt);

          if(activePoints.length > 0) {
            //get the internal index of slice in pie chart
            var clickedElementindex = activePoints[0]["_index"];

            //get specific label by index 
            var label = outageChart.data.labels[clickedElementindex];

            openOutageDetailPage(label);
          }
        }    

      } else {
		outageChart.data = {
	       labels: dates,
	       datasets: [{
	                    label: 'Outages',
	                    data: outages,
	                    backgroundColor: barColors,
	                    yAxisID: 'y-axis-outages'
	       },{
	                    label: 'Tests Performed',
	                    type: 'line',
	                    borderColor: 'rgb(153, 102, 255)',
	                    fill: false,
//	                    backgroundColor: 'rgb(153, 102, 255)',                    
	                    data: testCounts,
	                    yAxisID: 'y-axis-testCount'
	       }]
		};
		outageChart.update();
	  }
    }
    
    </script>
  </body>
</html>